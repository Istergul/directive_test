/* Created by Istergul */
"use strict";var module=angular.module("app",["ngCookies","ngRoute","app.directives","app.controllers","app.services"]).config(["$interpolateProvider",function(a){a.startSymbol("[["),a.endSymbol("]]")}]).config(["$locationProvider",function(a){a.html5Mode(!0)}]).config(["$httpProvider",function(a){a.defaults.xsrfHeaderName="X-CSRFToken",a.defaults.xsrfCookieName="csrftoken",a.interceptors.push("securityInterceptor")}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"static/src/partials/list.tpl.html",controller:"ListCtrl",resolve:{user:["security",function(a){return a.requestCurrentUser()}]}}).when("/secpage",{templateUrl:"static/src/partials/secpage.tpl.html",controller:"SecPageCtrl",resolve:["$injector",function(a){var b=a.get("security"),c=a.get("$q"),d=(a.get("securityRetryQueue"),b.requestCurrentUser());return console.log(2),d.then(function(a){return a?a:c.reject()})}]}).when("/add",{templateUrl:"static/src/partials/add.tpl.html",controller:"AddCtrl",resolve:function(){}}).when("/:id",{templateUrl:"static/src/partials/edit.tpl.html",controller:"EditCtrl",resolve:function(){}}).otherwise({redirectTo:"/"})}]).filter("newline2br",["$sce",function(a){return function(b){return a.trustAsHtml(b.replace(/\n/g,"<br>"))}}]).run(["$http","$cookies",function(a,b){a.defaults.headers.post["X-CSRFToken"]=b.csrftoken}]).run(["$rootScope","$cacheFactory",function(a,b){a.showError=function(a,b){return a.$dirty&&a.$error[b]},a.canSave=function(a){return a.$dirty&&a.$valid},a.getItemWithLevel=function(a,b){for(var c=0,d="";b>c;)d+=" * ",c++;return d+a},a.cache=b("cache")}]);angular.module("app.controllers",[]).controller("MainCtrl",["$scope","$rootScope","$http","Tasks","security",function(a,b,c,d,e){a.$watch(function(){return e.currentUser},function(b){a.user=b}),a.sendData=function(){c.get("/get-data")}}]).controller("ListCtrl",["$scope","$rootScope","Tasks",function(a,b,c){a.lastTaskId=b.cache.get("lastTaskId"),a.tasks=c.query(),a.removeTask=function(b){c.delete({id:b.id},null).$promise.then(function(){a.tasks=c.query()})}}]).controller("AddCtrl",["$scope","$rootScope","Tasks",function(a,b,c){a.isAddedNewTask=!1,a.task={},a.serverError=null,a.addTask=function(d){c.save(d).$promise.then(function(c){a.task=angular.copy(c),a.isAddedNewTask=!0,a.newTaskForm.$setPristine(),b.cache.put("lastTaskId",c.id),a.newTask={},a.serverError=null},function(b){a.serverError=b.data.detail})},a.tasks=c.query()}]).controller("EditCtrl",["$scope","$rootScope","Tasks","$routeParams",function(a,b,c,d){a.isUpdatedTask=!1,a.editTask=c.get({id:d.id}),a.serverError=null,a.updateTask=function(d){c.update({id:d.id},d).$promise.then(function(){a.isUpdatedTask=!0,a.updateTaskForm.$setPristine(),b.cache.put("lastTaskId",d.id),a.serverError=null},function(b){500==b.status&&(a.serverError=b.data.detail)})},a.tasks=c.query()}]).controller("LoginFormController",["$scope","security",function(a,b){a.user={},a.authError=null,a.authReason=null,b.getLoginReason()&&(a.authReason=b.isAuthenticated()?"login.reason.notAuthorized":"login.reason.notAuthenticated"),a.login=function(){a.authError=null,b.login(a.user.name,a.user.password).then(function(b){b||(a.authError="login.error.invalidCredentials")},function(){a.authError="login.error.serverError"})},a.logout=function(){b.logout()}}]).controller("SecPageCtrl",["$scope","security",function(){}]),angular.module("app.directives",[]).directive("loginToolbar",["security",function(a){var b={templateUrl:"static/src/partials/toolbar.tpl.html",restrict:"E",replace:!0,scope:!0,link:function(b){b.isAuthenticated=a.isAuthenticated,b.login=a.showLogin,b.logout=a.logout,b.$watch(function(){return a.currentUser},function(a){console.log("watch",a),b.currentUser=a})}};return b}]),angular.module("app.services",["ngResource"]).factory("Tasks",["$resource",function(a){return a("/api/tasks/:id",null,{update:{method:"PUT"}})}]).factory("securityInterceptor",["$injector","securityRetryQueue","$q",function(a,b){return{response:function(a){return console.log("response"),a},responseError:function(c){if(console.log("####",c),401===c.status){var d=b.pushRetryFn("unauthorized-server",function(){return console.log("&&&"),a.get("$http")(c.config)});return d}return c}}}]).factory("securityRetryQueue",["$q","$log",function(a,b){var c=[],d={onItemAddedCallbacks:[],hasMore:function(){return c.length>0},push:function(a){c.push(a),angular.forEach(d.onItemAddedCallbacks,function(c){try{c(a)}catch(d){b.error("securityRetryQueue.push(retryItem): callback threw an error"+d)}})},pushRetryFn:function(b,c){1===arguments.length&&(c=b,b=void 0);var e=a.defer(),f={reason:b,retry:function(){a.when(c()).then(function(a){e.resolve(a)},function(a){e.reject(a)})},cancel:function(){e.reject()}};return d.push(f),e.promise},retryReason:function(){return d.hasMore()&&c[0].reason},cancelAll:function(){for(;d.hasMore();)c.shift().cancel()},retryAll:function(){for(;d.hasMore();)c.shift().retry()}};return d}]).factory("security",["$http","$q","$location","securityRetryQueue",function(a,b,c,d){function e(a){a=a||"/",c.path(a)}function f(){console.log("open dialog")}function g(a){h(a)}function h(a){i=null,a?d.retryAll():(d.cancelAll(),e())}var i=null;d.onItemAddedCallbacks.push(function(){d.hasMore()&&j.showLogin()});var j={getLoginReason:function(){return d.retryReason()},showLogin:function(){f()},login:function(b,c){var d=a.post("/api-login",{name:b,password:c});return d.then(function(a){return console.log(a),j.currentUser=a.data.user,j.isAuthenticated()&&g(!0),j.isAuthenticated()})},cancelLogin:function(){g(!1),e()},logout:function(b){a.post("/api-logout").then(function(){console.log("logount"),j.currentUser=null,e(b)})},requestCurrentUser:function(){return console.log(100),j.currentUser?b.when(j.currentUser):a.get("/current-user").then(function(a){return j.currentUser=a.data.user,console.log("resp",a.data),j.currentUser})},currentUser:null,isAuthenticated:function(){return j.currentUser},isAdmin:function(){return!(!j.currentUser||!j.currentUser.admin)}};return j}]);